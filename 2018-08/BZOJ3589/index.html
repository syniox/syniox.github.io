<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>[BZOJ3589] 动态树 - Blog | qzkszj</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0/normalize.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0/build/pure-min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0/build/grids-responsive-min.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/atom-one-light.css"><style>.category-list-item{display:flex}.category-list-link{flex:1 0 auto}.category-list-count{text-align:right}.post .post-content pre code{padding:0 0}</style><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Blog | qzkszj" type="application/atom+xml"></head><body class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">[BZOJ3589] 动态树</h1><a id="logo" href="/">Blog | qzkszj</a><p class="description">过往如烟。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined">Home</i></a><a href="/archives/"><i class="fa undefined"> Archive</i></a><a href="/about/"><i class="fa undefined"> About</i></a><a href="/atom.xml"><i class="fa undefined"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">[BZOJ3589] 动态树</h1><div class="post-meta">August 05,2018<span> | </span><span class="category"><a href="/categories/Solution/">Solution</a></span><span> | 868,3 mins.</span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span></span><span id="busuanzi_container_page_pv"> | views: <span id="busuanzi_value_page_pv"></span></span></div><div class="tags"><a href="/tags/%E5%AE%B9%E6%96%A5/">容斥</a></div><div class="post-content"><h2 id="容斥-动态树">容斥-动态树</h2><p><a target="_blank" rel="noopener" href="http://192.168.102.138/JudgeOnline/problem.php?id=1716">BZOJ3589镜像</a></p><p>有一种很直观很暴力的做法：树剖暴力修改，对于每次询问打vis标记记录已访问过的点，对于每条链返回增量，然后打清除标记。</p><p>然后也有容斥做法，就是总链长减链的交。<br>（链底lca到链顶深度最大的那个点）<br>然后数据比较大，所以最好用树状数组。<br>现在想一想对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span>的子树增加一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">v_ x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>的意义是什么。<br>对于子树中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span>,统计<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span>到根的路径的权值和增加了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>y</mi><mo stretchy="false">]</mo><mo>−</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">(dep[y]-dep[x]+1)*v_ x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.58056em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><br>那么<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span>到根的路径的权值和可以写成：<br><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>x</mi></msub><mo stretchy="false">(</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>y</mi><mo stretchy="false">]</mo><mo>−</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\sum_ x(dep[y]-dep[x]+1)v_ x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497100000000001em;vertical-align:-.29971000000000003em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><br>拆开来有<br><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>x</mi></msub><mo stretchy="false">(</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>y</mi><mo stretchy="false">]</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><msub><mi>v</mi><mi>x</mi></msub><mo>−</mo><msub><mo>∑</mo><mi>x</mi></msub><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\sum_ x(dep[y]+1)v_ x-\sum_ xdep[x]v_ x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497100000000001em;vertical-align:-.29971000000000003em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.0497100000000001em;vertical-align:-.29971000000000003em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><br>前面那一项可以把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>y</mi><mo stretchy="false">]</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(dep[y]+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>这一项提出来，到询问的时候再处理。<br>这样我们只要维护两个信息：<br><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>x</mi></msub><msub><mi>v</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mo>∑</mo><mi>x</mi></msub><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\sum_ xv_ x,\sum_ xdep[x]v_ x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497100000000001em;vertical-align:-.29971000000000003em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><br>而且都是区间修改，单点查询。<br>这样就可以上树状数组了。</p><p>（事实证明容斥跑的还是很快的，我的代码比用标记的xsy rk2快了一倍）</p><p><a target="_blank" rel="noopener" href="https://github.com/syniox/Online_Judge_solutions/blob/master/BZOJ/3589.cpp">code</a>:</p><pre><code class="hljs language-c++"><span class="hljs-comment">//ans[y]=(dep[y]+1)*v[x]-dep[x]*v[x](dep[x]&lt;dep[y],lca(x,y)==x);</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstring&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cassert&gt;</span></span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">2</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mo=<span class="hljs-number">2147483647</span>;
<span class="hljs-keyword">typedef</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> lint;
<span class="hljs-type">int</span> n,fa[N],sz[N],dep[N],top[N],dfn[N],p_lca[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>];

<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">gtc</span><span class="hljs-params">()</span></span>&#123;
	<span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">20000</span>],*h,*t;
	<span class="hljs-keyword">if</span>(h==t)&#123;
		t=(h=buf)+<span class="hljs-built_in">fread</span>(buf,<span class="hljs-number">1</span>,<span class="hljs-number">20000</span>,stdin);
	&#125;
	<span class="hljs-keyword">return</span> *h++;
&#125;

<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">nxi</span><span class="hljs-params">()</span></span>&#123;
	<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>;
	<span class="hljs-type">char</span> c;
	<span class="hljs-keyword">while</span>((c=<span class="hljs-built_in">gtc</span>())&gt;<span class="hljs-string">&#x27;9&#x27;</span>||c&lt;<span class="hljs-string">&#x27;0&#x27;</span>);
	<span class="hljs-keyword">while</span>(x=x*<span class="hljs-number">10</span>+c<span class="hljs-number">-48</span>,(c=<span class="hljs-built_in">gtc</span>())&gt;=<span class="hljs-string">&#x27;0&#x27;</span>&amp;&amp;c&lt;=<span class="hljs-string">&#x27;9&#x27;</span>);
	<span class="hljs-keyword">return</span> x;
&#125;

<span class="hljs-keyword">namespace</span> G&#123;
	<span class="hljs-type">int</span> fir[N],son[N];
	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">edge</span>&#123;
		<span class="hljs-type">int</span> to,nx;
	&#125;eg[N&lt;&lt;<span class="hljs-number">1</span>];
	<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span></span>&#123;
		<span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt;
		eg[++cnt]=(edge)&#123;b,fir[a]&#125;;
		fir[a]=cnt;
	&#125;
	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;
		sz[x]=<span class="hljs-number">1</span>;
		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=fir[x];i;i=eg[i].nx)&#123;
			<span class="hljs-type">int</span> y=eg[i].to;
			<span class="hljs-keyword">if</span>(!sz[y])&#123;
				dep[y]=dep[x]+<span class="hljs-number">1</span>;
				fa[y]=x;
				<span class="hljs-built_in">dfs1</span>(y);
				<span class="hljs-keyword">if</span>(sz[y]&gt;sz[son[x]]) son[x]=y;
				sz[x]+=sz[y];
			&#125;
		&#125;
	&#125;
	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;
		<span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt;
		dfn[x]=++cnt;
		top[x]=son[fa[x]]==x?top[fa[x]]:x;
		<span class="hljs-keyword">if</span>(son[x]) <span class="hljs-built_in">dfs2</span>(son[x]);
		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=fir[x];i;i=eg[i].nx)&#123;
			<span class="hljs-type">int</span> y=eg[i].to;
			<span class="hljs-keyword">if</span>(!dfn[y]) <span class="hljs-built_in">dfs2</span>(y);
		&#125;
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">lca</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;
	<span class="hljs-keyword">while</span>(top[x]!=top[y])&#123;
		<span class="hljs-keyword">if</span>(dep[top[x]]&gt;dep[top[y]]) x=fa[top[x]];
		<span class="hljs-keyword">else</span> y=fa[top[y]];
	&#125;
	<span class="hljs-keyword">return</span> dep[x]&lt;dep[y]?x:y;
&#125;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">B_I_T</span>&#123;
	<span class="hljs-type">int</span> tr[N];
	<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">mod</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> v)</span></span>&#123;
		<span class="hljs-keyword">for</span>(;x&lt;=n;x+=x&amp;-x)&#123;
			tr[x]=(tr[x]+v)&amp;mo;
		&#125;
	&#125;
	<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">mod_t</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> v)</span></span>&#123;
		<span class="hljs-built_in">mod</span>(dfn[x],v);
		<span class="hljs-built_in">mod</span>(dfn[x]+sz[x],-v);
	&#125;
	<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;
		<span class="hljs-type">int</span> ans=<span class="hljs-number">0</span>;
		<span class="hljs-keyword">for</span>(;x;x-=x&amp;-x)&#123;
			ans=(ans+tr[x])&amp;mo;
		&#125;
		<span class="hljs-keyword">return</span> ans;
	&#125;
&#125;tr1,tr2;
<span class="hljs-comment">//1:sum 2:with dep</span>

<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">clen</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;
	<span class="hljs-type">int</span> ans1=tr1.<span class="hljs-built_in">ask</span>(dfn[x]),ans2=tr2.<span class="hljs-built_in">ask</span>(dfn[x]);
	<span class="hljs-keyword">return</span> (lint)(ans1*(dep[x]+<span class="hljs-number">1</span>)-ans2)&amp;mo;
&#125;

<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">solve</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>&#123;
	<span class="hljs-type">static</span> <span class="hljs-type">int</span> oga[<span class="hljs-number">5</span>],ogb[<span class="hljs-number">5</span>],zf[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>],_dp[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>],p_lca[<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>];
	<span class="hljs-built_in">memset</span>(zf,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span> zf);
	<span class="hljs-built_in">memset</span>(p_lca,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span> p_lca);
	<span class="hljs-built_in">memset</span>(_dp,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span> _dp);
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;k;++i)&#123;
		oga[i]=<span class="hljs-built_in">nxi</span>(),ogb[i]=<span class="hljs-built_in">nxi</span>();
		<span class="hljs-keyword">if</span>(dep[oga[i]]&lt;dep[ogb[i]]) std::<span class="hljs-built_in">swap</span>(oga[i],ogb[i]);
	&#125;
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;k;++i)&#123;
		p_lca[<span class="hljs-number">1</span>&lt;&lt;i]=oga[i];
		_dp[<span class="hljs-number">1</span>&lt;&lt;i]=ogb[i];
		zf[<span class="hljs-number">1</span>&lt;&lt;i]=<span class="hljs-number">1</span>;
	&#125;
	<span class="hljs-type">int</span> ans=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-number">1</span>&lt;&lt;k;++i)&#123;
		<span class="hljs-type">int</span> lt=i&amp;-i;
		<span class="hljs-keyword">if</span>(!p_lca[i])&#123;
			p_lca[i]=<span class="hljs-built_in">lca</span>(p_lca[i^lt],p_lca[lt]);
			_dp[i]=dep[_dp[i^lt]]&gt;dep[_dp[lt]]?_dp[i^lt]:_dp[lt];
			zf[i]=-zf[i^lt];
		&#125;
		<span class="hljs-keyword">if</span>(dep[p_lca[i]]&gt;=dep[_dp[i]])&#123;
			ans=(ans+zf[i]*(<span class="hljs-built_in">clen</span>(p_lca[i])-<span class="hljs-built_in">clen</span>(fa[_dp[i]])))&amp;mo;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> ans;
&#125;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ONLINE_JUDGE</span>
<span class="hljs-comment">//	freopen(&quot;.in&quot;,&quot;r&quot;,stdin);</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
	n=<span class="hljs-built_in">nxi</span>();
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;++i)&#123;
		<span class="hljs-type">int</span> a=<span class="hljs-built_in">nxi</span>(),b=<span class="hljs-built_in">nxi</span>();
		G::<span class="hljs-built_in">add</span>(a,b);
		G::<span class="hljs-built_in">add</span>(b,a);
	&#125;
	G::<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>);
	G::<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>);
	<span class="hljs-type">int</span> q=<span class="hljs-built_in">nxi</span>();
	<span class="hljs-keyword">while</span>(q--)&#123;
		<span class="hljs-type">int</span> op=<span class="hljs-built_in">nxi</span>(),k=<span class="hljs-built_in">nxi</span>();
		<span class="hljs-keyword">if</span>(op) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">solve</span>(k));
		<span class="hljs-keyword">else</span>&#123;
			<span class="hljs-type">int</span> v=<span class="hljs-built_in">nxi</span>();
			tr1.<span class="hljs-built_in">mod_t</span>(k,v);
			tr2.<span class="hljs-built_in">mod_t</span>(k,(lint)v*dep[k]&amp;mo);
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre></div><div class="page-navigator"><a class="pre" href="/2018-08/AGC005C/">Previous</a><a class="next" href="/2018-08/poset/">Next</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title">Categories</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Note/">Note</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Recollections/">Recollections</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Solution/">Solution</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Starred/">Starred</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title">Tags</div><div class="tagcloud"><a href="/tags/%E7%BB%84%E5%90%88%E6%95%B0%E5%AD%A6/" style="font-size:15px">组合数学</a> <a href="/tags/DP-%E4%BC%98%E5%8C%96/" style="font-size:15px">DP/优化</a> <a href="/tags/%E6%95%B0%E8%AE%BA/" style="font-size:16px">数论</a> <a href="/tags/%E5%AE%B9%E6%96%A5/" style="font-size:13px">容斥</a> <a href="/tags/%E9%9B%86%E5%90%88/" style="font-size:13px">集合</a> <a href="/tags/%E5%81%8F%E5%BA%8F/" style="font-size:13px">偏序</a> <a href="/tags/%E6%A0%91/" style="font-size:13px">树</a> <a href="/tags/%E6%8B%93%E6%89%91/" style="font-size:13px">拓扑</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E6%B5%81/" style="font-size:14px">网络流</a> <a href="/tags/%E7%BB%93%E8%AE%BA/" style="font-size:13px">结论</a> <a href="/tags/%E7%BE%A4%E8%AE%BA/" style="font-size:13px">群论</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size:13px">字符串</a> <a href="/tags/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" style="font-size:13px">线性代数</a> <a href="/tags/%E7%9F%A9%E9%98%B5/" style="font-size:13px">矩阵</a> <a href="/tags/%E5%A4%9A%E9%A1%B9%E5%BC%8F/" style="font-size:14px">多项式</a> <a href="/tags/%E6%94%AF%E9%85%8D%E6%A0%91/" style="font-size:13px">支配树</a> <a href="/tags/%E5%9B%BE%E8%AE%BA/" style="font-size:14px">图论</a> <a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:13px">数学</a></div></div><div class="widget"><div class="widget-title">Links</div><ul class="links-list"><li class="links-list-item"><a href="https://cnblogs.com/dedicatus545" title="dedicatus545" target="_blank">dedicatus545</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="https://blog.sshockwave.net" title="sshockwave" target="_blank">sshockwave</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="https://www.cnblogs.com/dcdcbigbig/" title="DCDCbigbig" target="_blank">DCDCbigbig</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="https://www.cnblogs.com/JackyhhJuRuo/" title="Jackyhh" target="_blank">Jackyhh</a></li></ul></div></div></div></div><div id="footer">© <a href="/" real="nofollow">Blog | qzkszj.</a><i> Powered by </i><a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a></div></body></html>